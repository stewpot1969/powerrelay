
AVRA   Ver. 1.3.0 main.asm Sun Oct  9 15:45:35 2016


         
         ;  file to control a relay
         
          .list
         
         ; VOLTAGE LEVELS
         ; ADC result = 50.8*voltage - 2.39
          .define   V_HIGH            668     ; ~13.2V
          .define   V_LOW             617     ; ~12.2V
         
         ; temp reg for things
          .def  scratch = r23
         ; timer countdown for state changes etc
          .def  count   = r24
          .define   COUNT_PRE_ON      5   ; seconds of engine-on volts before bootup
          .define   COUNT_PRE_OFF     5    ; seconds from shutdown relay on to power off
          .define   COUNT_PRE_SHUT    10     ; secs of engine-off volts before shutdown
         
         ; prescaler for second counter
          .def  count2  = r25
          .define   COUNT2_PRESCALE   4
         
         ; state of the switch
          .def  state   = r26
          .define   STATE_IDLE        1   ; resting state
          .define   STATE_PRE_ON      2   ; engine started
          .define   STATE_ON          3   ; power on to Pi
          .define   STATE_PRE_SHUT    4   ; engine turned off, Pi still running
          .define   STATE_PRE_OFF     5   ; shutdown relay on, Pi shutting down
          .define   STATE_MANUAL      6   ; button has been pressed
         
         ; state of the voltage input
          .def  v_state = r27
          .define   V_STATE_SICK      1     ; <12.2V - battery getting down
          .define   V_STATE_OK        2     ; 12.2-13.2V  - engine off, battery OK
          .define   V_STATE_HIGH      3     ; >13.2V - engine running
         
         
          .macro    set_output
              in    r16,DDR@0
              ori   r16,1<<@1
              out   DDR@0,r16
          .endm
          .macro    set_pullup
              in    r16,PORT@0
              ori   r16,1<<@1
              out   PORT@0,r16
          .endm
          .macro    set_high
              in    r16,PORT@0
              ori   r16,1<<@1
              out   PORT@0,r16
          .endm
          .macro    set_low
              in    r16,PORT@0
              andi  r16,255-(1<<@1)
              out   PORT@0,r16
          .endm
         
          .dseg
          .org  SRAM_START
         
         ; myval:    .byte 1
         
          .cseg
          .org          0x0000
         
         
          reset:
C:000000 e90f          ldi     r16,low(RAMEND)
C:000001 bf0d          out     SPL,r16
         
             ; setup I/O
             ; 1: _reset
             ; 2: PB3 - relay out
             ; 3: PB4 - 2nd relay?
             ; 4: GND
             ; 5: PB0 - button
             ; 6: PB1 - indicator LED
             ; 7: PB2 - ADC1 - sys V in
             ; 8: 5V
C:000002   +      set_output  B,1       ; PB1 LED out
C:000002 b307      in    r16,DDRB
C:000003 6002      ori   r16,1<<1
C:000004 bb07      out   DDRB,r16
C:000005   +      set_output  B,3       ; PB3 relay 1 out
C:000005 b307      in    r16,DDRB
C:000006 6008      ori   r16,1<<3
C:000007 bb07      out   DDRB,r16
C:000008   +      set_output  B,4       ; PB4 relay 2 out
C:000008 b307      in    r16,DDRB
C:000009 6100      ori   r16,1<<4
C:00000a bb07      out   DDRB,r16
C:00000b   +      set_pullup  B,0       ; PB0 button pullup
C:00000b b308      in    r16,PORTB
C:00000c 6001      ori   r16,1<<0
C:00000d bb08      out   PORTB,r16
         
             ; setup ADC (Vref=Vcc, /8 prescaler (125kHz))
             ; PB2 (ADC1), ADLAR=0
             
C:00000e e001          ldi     r16,1     ; Vref=Vcc, ADLAR=0, MUX1=1 (ADC1 PB2)
C:00000f b907          out     ADMUX,r16
             
C:000010 e803          ldi     r16,(1<<ADEN)+3 ; enable ADC, /8
C:000011 b906          out     ADCSRA,r16
             
             ; setup timer0
             ; compare output modes normal, WGM=CTC
C:000012 e002          ldi     r16,0b00000010
C:000013 bd0f          out     TCCR0A,r16
             ; WGM=CTC, clock prescaler = 1024
C:000014 e005          ldi     r16,0b00000101
C:000015 bf03          out     TCCR0B,r16
             ; overflow every 250 cycles = 0.5 seconds
C:000016 ef0a          ldi     r16,250
C:000017 bf06          out     OCR0A,r16
         
             ; prepare states and stuff for the loop
C:000018 ef8f          ldi     count,-1        ; timer off
C:000019 e0a1          ldi     state,STATE_IDLE    ; state=IDLE
C:00001a e094          ldi     count2,COUNT2_PRESCALE  ; load prescaler
         
          loop:
             ; step 1: wait for the interrupt flag to be set
C:00001b b708          in    r16,TIFR0
C:00001c ff02          sbrs  r16,OCF0A
C:00001d cffd          rjmp  loop
             
             ; step 2: clear interrupt flag
C:00001e e004          ldi   r16,1<<OCF0A
C:00001f bf08          out   TIFR0,r16
         
             ; step 3 - read ADC
C:000020 ec01          ldi     r16,(1<<ADEN)+(1<<ADSC)+1   ; start conversion
C:000021 b906          out     ADCSRA,r16
          wfadc:
C:000022 b106          in      r16,ADCSRA
C:000023 7100          andi    r16,(1<<ADIF)     ; check if ADIF is set (ADC complete)
C:000024 f3e9          breq    wfadc
         
             ; step 4 - look at the voltage
C:000025 b104          in      r16,ADCL
C:000026 b115          in      r17,ADCH
C:000027 e92c          ldi     r18,low(V_HIGH)
C:000028 e032          ldi     r19,high(V_HIGH)
C:000029 1702          cp      r16,r18     ; subtract V_HIGH from ADC
C:00002a 0713          cpc     r17,r19
C:00002b f010          brcs    s4_1    ; branch if ADC < V_HIGH
C:00002c e0b3          ldi     v_state,V_STATE_HIGH
C:00002d c008          rjmp    s5
          s4_1:
C:00002e e629          ldi     r18,low(V_LOW)
C:00002f e032          ldi     r19,high(V_LOW)
C:000030 1702          cp      r16,r18   ; subtract V_LOW from ADC
C:000031 0713          cpc     r17,r19
C:000032 f010          brcs    s4_2      ; branch if ADC < V_LOW
C:000033 e0b2          ldi     v_state,V_STATE_OK
C:000034 c001          rjmp    s5
          s4_2:
C:000035 e0b1          ldi     v_state,V_STATE_SICK
             
             ; step 5  - decrement timer prescaler and timer
          s5:
C:000036 3094          cpi   count2,COUNT2_PRESCALE
C:000037 f419          brne  s5a
C:000038   +      set_low     B,1   ; ############################
C:000038 b308      in    r16,PORTB
C:000039 7f0d      andi  r16,255-(1<<1)
C:00003a bb08      out   PORTB,r16
          s5a:
C:00003b 959a          dec   count2
C:00003c f6f1          brne  loop      ; no prescale zero? All done for this time
C:00003d   +      set_high    B,1       ;  ###################
C:00003d b308      in    r16,PORTB
C:00003e 6002      ori   r16,1<<1
C:00003f bb08      out   PORTB,r16
C:000040 e094          ldi   count2,COUNT2_PRESCALE    ; reload prescaler
C:000041 3f8f          cpi   count,-1      ; count=-1 means counter not being used
C:000042 f009          breq  s6
C:000043 958a          dec   count
         
             ; step 6 - split out based on state
          s6:
C:000044 30a1          cpi   state,STATE_IDLE
C:000045 f429          brne  s6_2    ; branch if not idle
C:000046 30b3            cpi   v_state,V_STATE_HIGH
C:000047 f419            brne  s6_2
C:000048 e0a2              ldi   state,STATE_PRE_ON    ; state=idle, v=high
C:000049 e085              ldi   count,COUNT_PRE_ON
C:00004a c04b              rjmp  s7
          s6_2:
C:00004b 30a2          cpi   state,STATE_PRE_ON
C:00004c f499          brne  s6_3    ; branch if not pre_on
C:00004d 30b1            cpi   v_state,V_STATE_SICK
C:00004e f419            brne  s6_2a
C:00004f e0a1              ldi   state,STATE_IDLE
C:000050 ef8f              ldi   count,-1
C:000051 c044              rjmp  s7
          s6_2a:
C:000052 30b2            cpi   v_state,V_STATE_OK
C:000053 f419            brne  s6_2b
C:000054 e0a1              ldi   state,STATE_IDLE
C:000055 ef8f              ldi   count,-1
C:000056 c03f              rjmp  s7
          s6_2b:
C:000057 2388            tst   count
C:000058 f009            breq  s6_2c
C:000059 c03c              rjmp  s7
          s6_2c:
C:00005a e0a3              ldi   state,STATE_ON    ; state=ON
C:00005b ef8f              ldi   count,-1    ; timer off
C:00005c   +          set_high  B,4     ; power relay on
C:00005c b308      in    r16,PORTB
C:00005d 6100      ori   r16,1<<4
C:00005e bb08      out   PORTB,r16
         ;        set_high  B,1     ; LED on
C:00005f c036              rjmp  s7
          s6_3:
C:000060 30a3          cpi   state,STATE_ON
C:000061 f459          brne  s6_4
C:000062 30b1            cpi   v_state,V_STATE_SICK
C:000063 f429            brne  s6_3a
C:000064   +          set_low B,4   ; power relay off
C:000064 b308      in    r16,PORTB
C:000065 7e0f      andi  r16,255-(1<<4)
C:000066 bb08      out   PORTB,r16
         ;        set_low B,1   ; LED off
C:000067 e0a1              ldi   state,STATE_IDLE
C:000068 c02d              rjmp  s7
          s6_3a:
C:000069 30b2            cpi   v_state,V_STATE_OK
C:00006a f411            brne  s6_4
C:00006b e0a4              ldi   state,STATE_PRE_SHUT
C:00006c e08a              ldi   count,COUNT_PRE_SHUT
          s6_4:
C:00006d 30a4          cpi   state,STATE_PRE_SHUT
C:00006e f4a1          brne  s6_5
C:00006f 30b1            cpi   v_state,V_STATE_SICK
C:000070 f429            brne  s6_4a
C:000071 e0a1              ldi   state,STATE_IDLE
C:000072   +          set_low   B,4   ; LED and relay off
C:000072 b308      in    r16,PORTB
C:000073 7e0f      andi  r16,255-(1<<4)
C:000074 bb08      out   PORTB,r16
         ;        set_low   B,1
C:000075 c020              rjmp    s7
          s6_4a:
C:000076 30b3            cpi   v_state,V_STATE_HIGH
C:000077 f419            brne  s6_4b
C:000078 e0a3              ldi   state,STATE_ON
C:000079 ef8f              ldi   count,-1
C:00007a c01b              rjmp    s7
          s6_4b:
C:00007b 2388            tst   count
C:00007c f4c9            brne    s7
C:00007d e0a5              ldi   state,STATE_PRE_OFF
C:00007e   +          set_high  B,3     ; shutdown relay on
C:00007e b308      in    r16,PORTB
C:00007f 6008      ori   r16,1<<3
C:000080 bb08      out   PORTB,r16
C:000081 e085              ldi   count,COUNT_PRE_OFF
C:000082 c013              rjmp  s7
          s6_5:
C:000083 30a5          cpi   state,STATE_PRE_OFF
C:000084 f489          brne  s7      ; should never branch
C:000085 30b1            cpi   v_state,V_STATE_SICK
C:000086 f429            brne  s6_5a
C:000087 e0a1              ldi   state,STATE_IDLE
C:000088   +          set_low   B,4     ; power relay off
C:000088 b308      in    r16,PORTB
C:000089 7e0f      andi  r16,255-(1<<4)
C:00008a bb08      out   PORTB,r16
         ;        set_low   B,1     ; LED off
C:00008b c00a              rjmp    s7
          s6_5a:
C:00008c 2388            tst   count
C:00008d f441            brne  s7
C:00008e e0a1              ldi   state,STATE_IDLE
C:00008f   +          set_low   B,3   ; shutdown relay off
C:00008f b308      in    r16,PORTB
C:000090 7f07      andi  r16,255-(1<<3)
C:000091 bb08      out   PORTB,r16
         ;        set_low   B,1   ; LED off
C:000092   +          set_low   B,4   ; power relay off
C:000092 b308      in    r16,PORTB
C:000093 7e0f      andi  r16,255-(1<<4)
C:000094 bb08      out   PORTB,r16
C:000095 ef8f              ldi   count,-1
         
            ; step 7: do it all again
          s7:
C:000096 cf84          rjmp  loop
             
         
         ;################################################################
         


Segment usage:
   Code      :       151 words (302 bytes)
   Data      :         0 bytes
   EEPROM    :         0 bytes

Assembly completed with no errors.
